# SLAC FreightLink 360 — Laravel Backend

Laravel 11 + MySQL 8.0 API backend for the SLAC FreightLink 360 freight management platform.

---

## Stack

| Layer | Technology |
|-------|-----------|
| Framework | Laravel 11 |
| Auth | Laravel Sanctum (Bearer tokens) |
| Database | MySQL 8.0 |
| Cache / Queue | Redis |
| Realtime | Pusher (or Soketi self-hosted) |
| File Storage | AWS S3 / MinIO |
| AI | OpenAI / Google Gemini (via API) |
| Email | SMTP (configurable) |

---

## Requirements

- PHP 8.3+
- Composer 2+
- MySQL 8.0+
- Redis 7+
- Node.js 20+ (for Vite assets, if serving Blade views)

---

## Quick Start

```bash
# 1. Clone and install
git clone https://github.com/your-org/slac-freightlink-api.git
cd slac-freightlink-api
composer install

# 2. Environment
cp .env.example .env
php artisan key:generate

# 3. Configure .env — see Environment Variables section below

# 4. Database
php artisan migrate
php artisan db:seed        # loads demo data

# 5. Bootstrap super admin
php artisan admin:bootstrap \
  --name="John Doe" \
  --email="admin@shipperslink.com" \
  --password="ChangeMe123!"

# 6. Start development server
php artisan serve

# 7. Start queue worker
php artisan queue:work redis --queue=critical,high,default,emails

# 8. Start scheduler (or add to cron)
php artisan schedule:work
```

---

## Environment Variables

Copy `.env.example` to `.env` and fill in:

```env
APP_NAME="SLAC FreightLink 360"
APP_ENV=production
APP_KEY=                         # generated by artisan key:generate
APP_URL=https://api.shipperslink.com

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=slac_freightlink
DB_USERNAME=
DB_PASSWORD=

CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis

REDIS_HOST=127.0.0.1
REDIS_PORT=6379

# Sanctum
SANCTUM_STATEFUL_DOMAINS=app.shipperslink.com

# Storage
FILESYSTEM_DISK=s3
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=
AWS_BUCKET=slac-documents

# Broadcasting (Pusher)
BROADCAST_DRIVER=pusher
PUSHER_APP_ID=
PUSHER_APP_KEY=
PUSHER_APP_SECRET=
PUSHER_HOST=
PUSHER_PORT=443
PUSHER_SCHEME=https

# AI
OPENAI_API_KEY=                  # or Gemini API key
AI_MODEL=google/gemini-2.5-flash
AI_RATE_LIMIT=10                 # requests per minute per user

# Banking
BANK_WEBHOOK_SECRET=
BANK_LOW_BALANCE_THRESHOLD=10000
BANK_LARGE_TRANSACTION_THRESHOLD=50000

# Mail
MAIL_MAILER=smtp
MAIL_HOST=
MAIL_PORT=587
MAIL_USERNAME=
MAIL_PASSWORD=
MAIL_FROM_ADDRESS=noreply@shipperslink.com
MAIL_FROM_NAME="SLAC FreightLink 360"
MAIL_ADMIN_ADDRESS=admin@shipperslink.com
```

---

## Project Structure

```
app/
├── Console/
│   ├── Commands/
│   │   └── BootstrapAdminCommand.php   # php artisan admin:bootstrap
│   └── Kernel.php                       # Scheduled jobs
├── Events/                              # Broadcasting events
│   ├── AccountLocked.php
│   ├── BankAlertCreated.php
│   ├── BankSynced.php
│   ├── NewMessage.php
│   ├── NotificationCreated.php
│   └── ShipmentStatusChanged.php
├── Http/
│   ├── Controllers/
│   │   ├── AI/AIChatController.php      # SSE streaming AI
│   │   ├── Admin/                       # User & client management
│   │   ├── Auth/                        # Staff & client auth
│   │   ├── Banking/                     # Bank sync, reconciliation
│   │   ├── Client/                      # Client portal endpoints
│   │   ├── Finance/                     # Invoices, expenses, job costs
│   │   ├── NotificationController.php
│   │   └── ReportController.php
│   ├── Middleware/
│   │   ├── CheckDepartmentAccess.php
│   │   ├── CheckRole.php
│   │   ├── EnsureAccountNotLocked.php
│   │   ├── EnsureClientIsActive.php
│   │   ├── EnsureIsAdmin.php
│   │   ├── EnsurePasswordChanged.php
│   │   └── InactivityTimeout.php
│   └── Requests/                        # Form Request validators
├── Jobs/                                # Queue jobs
│   ├── AutoMatchTransactionsJob.php
│   ├── BankAutoSyncJob.php
│   ├── CheckOverdueInvoicesJob.php
│   ├── CheckRegistrarRenewalJob.php
│   ├── EscalateUnpaidInvoicesJob.php
│   ├── SendDailyDigestJob.php
│   └── SendWeeklyReportJob.php
├── Listeners/                           # Event listeners
│   ├── SendAccountLockedEmail.php
│   └── SendShipmentStatusEmail.php
├── Mail/                                # Mailable classes
│   ├── AccountLockedMail.php
│   ├── DailyDigestMail.php
│   ├── InvoiceSentMail.php
│   ├── ShipmentStatusChangedMail.php
│   └── WeeklyReportMail.php
├── Models/                              # Eloquent models
├── Observers/                           # Auto audit logging
│   ├── BankConnectionObserver.php
│   ├── BankReconciliationObserver.php
│   ├── BankTransactionObserver.php
│   ├── ClientProfileObserver.php
│   ├── ClientShipmentObserver.php
│   ├── FinanceExpenseObserver.php
│   ├── FinanceInvoiceObserver.php
│   ├── FinanceJobCostObserver.php
│   ├── ProfileObserver.php
│   └── UserRoleObserver.php
└── Providers/
    ├── AppServiceProvider.php           # Observer & rate limiter registration
    ├── BroadcastServiceProvider.php
    └── EventServiceProvider.php

routes/
├── api.php                              # All API routes
└── channels.php                         # Broadcasting channel auth

resources/views/                         # Blade templates
database/
├── migrations/                          # Schema migrations
└── seeders/                             # Demo data seeders
```

---

## API Authentication

All staff API requests require:
```
Authorization: Bearer <sanctum_token>
```

Tokens are obtained from `POST /api/v1/auth/login`.

Client portal uses `POST /api/v1/client/auth/login` (separate guard).

---

## Key API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/auth/login` | Staff login |
| POST | `/api/v1/auth/logout` | Staff logout |
| POST | `/api/v1/auth/change-password` | Change password |
| GET | `/api/v1/users` | List staff users (admin) |
| POST | `/api/v1/users` | Create staff user (admin) |
| GET | `/api/v1/finance/invoices` | List invoices |
| POST | `/api/v1/finance/invoices` | Create invoice |
| POST | `/api/v1/finance/invoices/{id}/pay` | Record payment |
| GET | `/api/v1/banking/connections` | List bank connections |
| POST | `/api/v1/banking/sync/{id}` | Trigger manual sync |
| GET | `/api/v1/ai/chat` | AI chat (SSE stream) |
| GET | `/api/v1/client/shipments` | Client: list shipments |
| GET | `/api/v1/notifications` | Staff notifications |

Full OpenAPI spec: `docs/openapi.yaml`

---

## Background Jobs Schedule

| Job | Schedule |
|-----|----------|
| `SendDailyDigestJob` | Daily 08:00 |
| `CheckOverdueInvoicesJob` | Daily 09:00 |
| `EscalateUnpaidInvoicesJob` | Daily 09:30 |
| `BankAutoSyncJob` | Every 30 min |
| `CheckRegistrarRenewalJob` | Weekly Monday 07:00 |
| `SendWeeklyReportJob` | Weekly Friday 17:00 |

Start the scheduler:
```bash
# Development
php artisan schedule:work

# Production (add to system cron)
* * * * * cd /path/to/app && php artisan schedule:run >> /dev/null 2>&1
```

---

## Queue Workers

```bash
# All queues with priority ordering
php artisan queue:work redis \
  --queue=critical,high,default,emails \
  --tries=3 \
  --backoff=60

# Monitor with Laravel Horizon (recommended for production)
composer require laravel/horizon
php artisan horizon
```

---

## Realtime (Pusher)

Configure Pusher credentials in `.env`. The frontend connects using:
```typescript
import Echo from 'laravel-echo';
import Pusher from 'pusher-js';

window.Pusher = Pusher;
const echo = new Echo({
  broadcaster: 'pusher',
  key: import.meta.env.VITE_PUSHER_APP_KEY,
  cluster: import.meta.env.VITE_PUSHER_APP_CLUSTER,
  forceTLS: true,
  authEndpoint: `${import.meta.env.VITE_API_URL}/api/v1/broadcasting/auth`,
  auth: {
    headers: { Authorization: `Bearer ${localStorage.getItem('slac_token')}` }
  }
});
```

Channels:
- `private-user.{userId}` — personal notifications
- `private-dept.{department}` — department-wide notifications
- `private-client.{customerId}` — client portal updates
- `private-banking` — bank sync and alerts

---

## Security

- 5 failed login attempts → account locked
- 15-minute staff inactivity timeout
- 30-minute client inactivity timeout
- All mutations produce `audit_logs` entries
- Client data strictly scoped by `customer_id` (never accepted from request)
- Signed URLs for file downloads (15-minute expiry)
- No public registration — all accounts created by admins only

---

## Running Tests

```bash
php artisan test
php artisan test --filter=AuthTest
```

---

## Deployment Checklist

- [ ] Set `APP_ENV=production` and `APP_DEBUG=false`
- [ ] Run `php artisan config:cache && php artisan route:cache && php artisan view:cache`
- [ ] Run `php artisan migrate --force`
- [ ] Configure queue worker as a system service (Supervisor recommended)
- [ ] Configure scheduler in cron
- [ ] Set `SANCTUM_STATEFUL_DOMAINS` to your frontend domain
- [ ] Configure S3 bucket with private ACL
- [ ] Set `BANK_WEBHOOK_SECRET` and validate in `BankWebhookController`
- [ ] Restrict admin bootstrap command to CLI only (already enforced)

---

*SLAC FreightLink 360 v1.0 — Last updated: 2026-02-18*
